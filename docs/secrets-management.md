# Secrets Management - PostgreSQL HA/DR

**[English](#english)** | **[Português](#português)**

---

## English

### Overview

All sensitive credentials are managed through **AWS SSM Parameter Store** with encryption via AWS KMS. Passwords are automatically generated during infrastructure provisioning and securely distributed to instances at boot time.

### Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                    Terraform (ssm.tf)                            │
│                                                                  │
│  random_password.postgres      ──►  /pgha/postgres-password     │
│  random_password.replication   ──►  /pgha/replication-password  │
│  random_password.pgbouncer     ──►  /pgha/pgbouncer-password    │
│  random_password.patroni_api   ──►  /pgha/patroni-api-password  │
│                                                                  │
│  (24 characters, special chars, SecureString)                   │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│              AWS SSM Parameter Store                             │
│              (Encrypted with KMS key: aws/ssm)                  │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│              EC2 Instances (user-data bootstrap)                 │
│                                                                  │
│  aws ssm get-parameter --name "/pgha/..." --with-decryption     │
│                                                                  │
│  Used by: Patroni, PostgreSQL, PgBouncer, Exporters             │
└─────────────────────────────────────────────────────────────────┘
```

### Password Inventory

| SSM Parameter Path | Purpose | Used By |
|--------------------|---------|---------|
| `/pgha/postgres-password` | PostgreSQL superuser (`postgres`) | Patroni, PgBouncer, postgres_exporter |
| `/pgha/replication-password` | Replication user (`replicator`) | Patroni streaming replication |
| `/pgha/pgbouncer-password` | PgBouncer admin user | PgBouncer, pgbouncer_exporter |
| `/pgha/patroni-api-password` | Patroni REST API auth | Patroni API endpoints |

### Password Generation

Passwords are generated by Terraform's `random_password` resource:

```hcl
resource "random_password" "postgres" {
  length           = 24
  special          = true
  override_special = "!#$%&*()-_=+[]{}<>:?"
}
```

**Characteristics:**
- **Length:** 24 characters
- **Complexity:** Alphanumeric + special characters
- **Special chars:** `!#$%&*()-_=+[]{}<>:?` (excluding problematic chars like `@`, `'`, `"`)

### Password Storage

Passwords are stored as `SecureString` in SSM Parameter Store:

```hcl
resource "aws_ssm_parameter" "postgres_password" {
  name  = "/pgha/postgres-password"
  type  = "SecureString"
  value = random_password.postgres.result
  # Uses AWS-managed KMS key (aws/ssm) - free tier
}
```

**Security features:**
- **Encryption at rest:** AWS KMS (key: `alias/aws/ssm`)
- **Encryption in transit:** TLS
- **Access control:** IAM policies restrict access to EC2 roles only
- **Audit trail:** CloudTrail logs all parameter access

### Password Retrieval

EC2 instances fetch passwords during bootstrap via IAM instance profile:

```bash
POSTGRES_PASSWORD=$(aws ssm get-parameter \
  --name "/pgha/postgres-password" \
  --with-decryption \
  --query 'Parameter.Value' \
  --output text \
  --region us-east-1)
```

### IAM Permissions

The Patroni EC2 role has permission to read only the required parameters:

```json
{
  "Effect": "Allow",
  "Action": ["ssm:GetParameter"],
  "Resource": [
    "arn:aws:ssm:*:*:parameter/pgha/postgres-password",
    "arn:aws:ssm:*:*:parameter/pgha/replication-password",
    "arn:aws:ssm:*:*:parameter/pgha/pgbouncer-password",
    "arn:aws:ssm:*:*:parameter/pgha/patroni-api-password"
  ]
}
```

### Viewing Current Passwords

```bash
# View a single password
aws ssm get-parameter \
  --profile postgresql-ha-profile \
  --name "/pgha/postgres-password" \
  --with-decryption \
  --query 'Parameter.Value' \
  --output text

# View all passwords
for p in postgres-password replication-password pgbouncer-password patroni-api-password; do
  echo "$p: $(aws ssm get-parameter \
    --profile postgresql-ha-profile \
    --name "/pgha/$p" \
    --with-decryption \
    --query 'Parameter.Value' \
    --output text)"
done
```

### Password Rotation

To rotate passwords:

1. **Update SSM parameter** (manual or via Terraform):
   ```bash
   NEW_PASSWORD=$(openssl rand -base64 18)
   aws ssm put-parameter \
     --profile postgresql-ha-profile \
     --name "/pgha/postgres-password" \
     --value "$NEW_PASSWORD" \
     --type SecureString \
     --overwrite
   ```

2. **Update PostgreSQL** (on primary):
   ```sql
   ALTER USER postgres PASSWORD 'new_password';
   ```

3. **Restart services** to pick up new password:
   ```bash
   sudo systemctl restart patroni pgbouncer
   ```

> **Note:** For zero-downtime rotation, consider implementing a dual-password strategy or using AWS Secrets Manager with automatic rotation.

### Security Best Practices

1. **Never log passwords** - Scripts use `set +x` before password operations
2. **Never hardcode** - All passwords come from SSM at runtime
3. **Least privilege** - Each component only accesses required parameters
4. **Encryption everywhere** - TLS for transit, KMS for rest
5. **Audit access** - CloudTrail logs all SSM GetParameter calls

---

## Português

### Visão Geral

Todas as credenciais sensíveis são gerenciadas através do **AWS SSM Parameter Store** com criptografia via AWS KMS. As senhas são geradas automaticamente durante o provisionamento da infraestrutura e distribuídas de forma segura para as instâncias no boot.

### Arquitetura

```
┌─────────────────────────────────────────────────────────────────┐
│                    Terraform (ssm.tf)                            │
│                                                                  │
│  random_password.postgres      ──►  /pgha/postgres-password     │
│  random_password.replication   ──►  /pgha/replication-password  │
│  random_password.pgbouncer     ──►  /pgha/pgbouncer-password    │
│  random_password.patroni_api   ──►  /pgha/patroni-api-password  │
│                                                                  │
│  (24 caracteres, chars especiais, SecureString)                 │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│              AWS SSM Parameter Store                             │
│              (Criptografado com KMS key: aws/ssm)               │
└───────────────────────────────┬─────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│              Instâncias EC2 (bootstrap user-data)                │
│                                                                  │
│  aws ssm get-parameter --name "/pgha/..." --with-decryption     │
│                                                                  │
│  Usado por: Patroni, PostgreSQL, PgBouncer, Exporters           │
└─────────────────────────────────────────────────────────────────┘
```

### Inventário de Senhas

| Caminho SSM | Propósito | Usado Por |
|-------------|-----------|-----------|
| `/pgha/postgres-password` | Superusuário PostgreSQL (`postgres`) | Patroni, PgBouncer, postgres_exporter |
| `/pgha/replication-password` | Usuário de replicação (`replicator`) | Streaming replication do Patroni |
| `/pgha/pgbouncer-password` | Usuário admin do PgBouncer | PgBouncer, pgbouncer_exporter |
| `/pgha/patroni-api-password` | Autenticação da API REST do Patroni | Endpoints da API Patroni |

### Geração de Senhas

As senhas são geradas pelo recurso `random_password` do Terraform:

```hcl
resource "random_password" "postgres" {
  length           = 24
  special          = true
  override_special = "!#$%&*()-_=+[]{}<>:?"
}
```

**Características:**
- **Tamanho:** 24 caracteres
- **Complexidade:** Alfanuméricos + caracteres especiais
- **Chars especiais:** `!#$%&*()-_=+[]{}<>:?` (excluindo chars problemáticos como `@`, `'`, `"`)

### Armazenamento de Senhas

As senhas são armazenadas como `SecureString` no SSM Parameter Store:

```hcl
resource "aws_ssm_parameter" "postgres_password" {
  name  = "/pgha/postgres-password"
  type  = "SecureString"
  value = random_password.postgres.result
  # Usa KMS key gerenciada pela AWS (aws/ssm) - gratuito
}
```

**Recursos de segurança:**
- **Criptografia em repouso:** AWS KMS (key: `alias/aws/ssm`)
- **Criptografia em trânsito:** TLS
- **Controle de acesso:** Políticas IAM restringem acesso apenas a roles EC2
- **Trilha de auditoria:** CloudTrail registra todos os acessos aos parâmetros

### Recuperação de Senhas

As instâncias EC2 buscam as senhas durante o bootstrap via IAM instance profile:

```bash
POSTGRES_PASSWORD=$(aws ssm get-parameter \
  --name "/pgha/postgres-password" \
  --with-decryption \
  --query 'Parameter.Value' \
  --output text \
  --region us-east-1)
```

### Permissões IAM

O role EC2 do Patroni tem permissão para ler apenas os parâmetros necessários:

```json
{
  "Effect": "Allow",
  "Action": ["ssm:GetParameter"],
  "Resource": [
    "arn:aws:ssm:*:*:parameter/pgha/postgres-password",
    "arn:aws:ssm:*:*:parameter/pgha/replication-password",
    "arn:aws:ssm:*:*:parameter/pgha/pgbouncer-password",
    "arn:aws:ssm:*:*:parameter/pgha/patroni-api-password"
  ]
}
```

### Visualizar Senhas Atuais

```bash
# Ver uma senha
aws ssm get-parameter \
  --profile postgresql-ha-profile \
  --name "/pgha/postgres-password" \
  --with-decryption \
  --query 'Parameter.Value' \
  --output text

# Ver todas as senhas
for p in postgres-password replication-password pgbouncer-password patroni-api-password; do
  echo "$p: $(aws ssm get-parameter \
    --profile postgresql-ha-profile \
    --name "/pgha/$p" \
    --with-decryption \
    --query 'Parameter.Value' \
    --output text)"
done
```

### Rotação de Senhas

Para rotacionar senhas:

1. **Atualizar parâmetro SSM** (manual ou via Terraform):
   ```bash
   NEW_PASSWORD=$(openssl rand -base64 18)
   aws ssm put-parameter \
     --profile postgresql-ha-profile \
     --name "/pgha/postgres-password" \
     --value "$NEW_PASSWORD" \
     --type SecureString \
     --overwrite
   ```

2. **Atualizar PostgreSQL** (no primary):
   ```sql
   ALTER USER postgres PASSWORD 'nova_senha';
   ```

3. **Reiniciar serviços** para usar nova senha:
   ```bash
   sudo systemctl restart patroni pgbouncer
   ```

> **Nota:** Para rotação sem downtime, considere implementar estratégia de dual-password ou usar AWS Secrets Manager com rotação automática.

### Boas Práticas de Segurança

1. **Nunca logar senhas** - Scripts usam `set +x` antes de operações com senhas
2. **Nunca hardcode** - Todas as senhas vêm do SSM em runtime
3. **Menor privilégio** - Cada componente acessa apenas parâmetros necessários
4. **Criptografia em todo lugar** - TLS para trânsito, KMS para repouso
5. **Auditar acesso** - CloudTrail registra todas as chamadas SSM GetParameter

---

## References

- [AWS SSM Parameter Store](https://docs.aws.amazon.com/systems-manager/latest/userguide/systems-manager-parameter-store.html)
- [Terraform random_password](https://registry.terraform.io/providers/hashicorp/random/latest/docs/resources/password)
- [AWS KMS](https://docs.aws.amazon.com/kms/latest/developerguide/overview.html)
